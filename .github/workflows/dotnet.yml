name: .NET

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write  # Needed for GitHub Releases

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.0.x

      - name: Install Workloads
        run: dotnet workload restore YoutubeDownloader.Wpf/YoutubeDownloader.Wpf.csproj

      - name: Restore dependencies
        run: dotnet restore YoutubeDownloader.Wpf/YoutubeDownloader.Wpf.csproj

      - name: Install Velopack CLI
        run: dotnet tool install -g vpk

      - name: Publish
        run: dotnet publish YoutubeDownloader.Wpf/YoutubeDownloader.Wpf.csproj -c Release -r win-x64 -o publish /p:DebugType=None /p:DebugSymbols=false

      - name: Import Certificate to Windows OS
        shell: pwsh
        run: |
          # 1. Decode the Base64 certificate
          $certBase64 = "${{ secrets.CODE_SIGNING_CERT }}".Trim()
          $bytes = [System.Convert]::FromBase64String($certBase64)
          [System.IO.File]::WriteAllBytes("cert.pfx", $bytes)

          # 2. Import it securely into the Windows CurrentUser Certificate Store
          $pfx = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2
          $pfx.Import("cert.pfx", "${{ secrets.CERT_PASSWORD }}", [System.Security.Cryptography.X509Certificates.X509KeyStorageFlags]::DefaultKeySet)
          
          $store = New-Object System.Security.Cryptography.X509Certificates.X509Store([System.Security.Cryptography.X509Certificates.StoreName]::My, [System.Security.Cryptography.X509Certificates.StoreLocation]::CurrentUser)
          $store.Open([System.Security.Cryptography.X509Certificates.OpenFlags]::ReadWrite)
          $store.Add($pfx)
          $store.Close()

          # 3. Grab the Thumbprint and save it to GitHub Environment Variables
          $thumbprint = $pfx.Thumbprint
          Write-Host "Certificate imported successfully! Thumbprint: $thumbprint"
          echo "CERT_THUMBPRINT=$thumbprint" >> $env:GITHUB_ENV

      - name: Velopack Pack
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          
          # Notice we use /sha1 instead of /f and /p. 
          # Signtool will pull the cert directly from the Windows OS, bypassing all path/password bugs.
          vpk pack -u YoutubeDownloader `
                   -v $version `
                   -p publish `
                   -e YoutubeDownloader.Wpf.exe `
                   --packTitle "Youtube Downloader" `
                   --signParams "/fd SHA256 /sha1 $env:CERT_THUMBPRINT"

      - name: Velopack Upload & GitHub Release
        run: |
          vpk upload github --repoUrl ${{ github.server_url }}/${{ github.repository }} --publish --token ${{ secrets.GITHUB_TOKEN }} --tag ${{ github.ref_name }}
